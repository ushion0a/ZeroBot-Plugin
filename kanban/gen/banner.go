// Package main generates banner.go
package main

import (
	"bytes"
	"fmt"
	"os"
	"os/exec"
	"strings"
	"time"
)

const banner = `// Code generated by kanban/gen. DO NOT EDIT.

package banner

// Version ...
var Version = "%s"

// Copyright ...
var Copyright = "© 2020 - %d FloatTech"

// Banner ...
var Banner = "* OneBot + ZeroBot + Golang\n" +
	"* Version " + Version + " - %s\n" +
	"* Copyright " + Copyright + ". All Rights Reserved.\n" +
	"* Project: https://github.com/FloatTech/ZeroBot-Plugin"
`

const timeformat = `2006-01-02 15:04:05 +0800 CST`

func main() {
	f, err := os.Create("banner/banner.go")
	if err != nil {
		panic(err)
	}
	defer f.Close()
	
	vartag := bytes.NewBuffer(nil)
	vartagcmd := exec.Command("git", "tag", "--sort=committerdate")
	vartagcmd.Stdout = vartag
	err = vartagcmd.Run()
	if err != nil {
		panic(err)
	}
	
	// 修复：正确处理标签输出
	output := strings.TrimSpace(vartag.String())
	var version string
	
	if output == "" {
		// 如果没有git标签，使用默认版本
		version = "v0.0.0-dev"
	} else {
		// 分割标签，过滤空行
		lines := strings.Split(output, "\n")
		validTags := make([]string, 0)
		
		for _, line := range lines {
			if strings.TrimSpace(line) != "" {
				validTags = append(validTags, line)
			}
		}
		
		if len(validTags) == 0 {
			version = "v0.0.0-dev"
		} else {
			// 使用最新的标签（最后一个）
			version = validTags[len(validTags)-1]
		}
	}
	
	now := time.Now()
	_, err = fmt.Fprintf(f, banner, version, now.Year(), now.Format(timeformat))
	if err != nil {
		panic(err)
	}
}
